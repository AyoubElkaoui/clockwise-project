services:
  # ------------------------------
  # Firebird Database
  # ------------------------------
  firebird:
    image: jacobalberty/firebird:v3.0
    container_name: clockwise-firebird
    environment:
      - FIREBIRD_USER=SYSDBA
      - FIREBIRD_PASSWORD=masterkey
      - ISC_PASSWORD=masterkey
    ports:
      - "3050:3050"
    volumes:
      - firebird_data:/firebird/data
    networks:
      - clockwise-network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "3050"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ------------------------------
  # Backend API (.NET 8) met Hot Reload
  # ------------------------------
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: clockwise-backend
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5000
      - DOTNET_USE_POLLING_FILE_WATCHER=true
      - DOTNET_WATCH_RESTART_ON_RUDE_EDIT=true
      - SEED_ON_START=false
      - DefaultConnection=Database=firebird:3050:CLOCKWISE.FDB;User=SYSDBA;Password=masterkey;Dialect=3;Charset=UTF8;ServerType=1;ClientLibrary=/usr/lib/x86_64-linux-gnu/libfbclient.so.2;Pooling=true;CreateDatabase=true
    ports:
      - "5000:5000"
    depends_on:
      firebird:
        condition: service_healthy
    networks:
      - clockwise-network
    volumes:
      # Mount source code voor hot reload
      - ./backend:/app:cached
      # Exclude bin en obj folders (blijven in container)
      - /app/bin
      - /app/obj
      # Cache NuGet packages
      - nuget_cache:/root/.nuget/packages
    restart: unless-stopped
    stdin_open: true
    tty: true

  # ------------------------------
  # Frontend (Next.js) met Hot Reload
  # ------------------------------
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: clockwise-frontend
    environment:
      - NODE_ENV=development
      - NEXT_PUBLIC_API_URL=http://localhost:5000
      - INTERNAL_API_URL=http://localhost:5000
      - WATCHPACK_POLLING=true
      - CHOKIDAR_USEPOLLING=true
    ports:
      - "3000:3000"
    depends_on:
      - backend
    networks:
      - clockwise-network
    volumes:
      # Mount source code voor hot reload
      - ./frontend:/app:cached
      # Use named volumes for node_modules and .next to persist them
      - frontend_node_modules:/app/node_modules
      - frontend_next:/app/.next
    restart: unless-stopped
    stdin_open: true
    tty: true

networks:
  clockwise-network:
    driver: bridge

volumes:
  firebird_data:
  nuget_cache:
  frontend_node_modules:
  frontend_next:
